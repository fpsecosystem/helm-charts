# Universal Application Helm Chart

Deploy any PHP application (Laravel, WordPress, Symfony, or custom) with minimal configuration by simply specifying your framework and container image. This chart handles database setup, environment variables, and deployment automatically.

## üöÄ Quick Start

Deploy any application in 2 steps:
1. **Set your framework** (laravel, wordpress, symfony, or leave empty for custom)
2. **Set your container image**

```bash
# Deploy Laravel application
helm install my-laravel-app . \
  --set appConfig.framework="laravel" \
  --set controllers.main.containers.main.image.repository="your-registry/laravel-app" \
  --set controllers.main.containers.main.image.tag="latest"

# Deploy WordPress site
helm install my-wordpress . \
  --set appConfig.framework="wordpress" \
  --set controllers.main.containers.main.image.repository="wordpress" \
  --set controllers.main.containers.main.image.tag="6.4-apache"

# Deploy Symfony application
helm install my-symfony . \
  --set appConfig.framework="symfony" \
  --set controllers.main.containers.main.image.repository="your-registry/symfony-app" \
  --set controllers.main.containers.main.image.tag="latest"
```

## ‚ú® Key Features

- **Framework Detection**: Automatically configures database environment variables for Laravel, WordPress, and Symfony
- **MariaDB Integration**: Built-in MariaDB operator support with dynamic connection detection
- **Dynamic Ingress**: Automatic subdomain generation with `{release-name}.{domain}` pattern
- **Minimal Configuration**: Deploy any application with just framework and image settings
- **Production Ready**: Includes persistence, health checks, and scaling configuration

## üéØ Framework Detection

The chart automatically detects your framework and configures the appropriate database environment variables:

### Laravel Applications
Set `appConfig.framework: "laravel"` and get:
```yaml
DB_CONNECTION: mysql
DB_HOST: framework-mariadb.default.svc.cluster.local
DB_PORT: 3306
DB_DATABASE: my-laravel-app-db
DB_USERNAME: my-laravel-app-user
DB_PASSWORD: <auto-generated>
```

### WordPress Applications
Set `appConfig.framework: "wordpress"` and get:
```yaml
WORDPRESS_DB_HOST: framework-mariadb.default.svc.cluster.local:3306
WORDPRESS_DB_NAME: my-wordpress-db
WORDPRESS_DB_USER: my-wordpress-user
WORDPRESS_DB_PASSWORD: <auto-generated>
```

### Symfony Applications
Set `appConfig.framework: "symfony"` and get:
```yaml
DATABASE_URL: mysql://my-symfony-app-user:<auto-generated>@framework-mariadb.default.svc.cluster.local:3306/my-symfony-app-db?serverVersion=10.11&charset=utf8mb4
```

### Custom Applications
Leave `appConfig.framework` empty and get generic database variables plus `DATABASE_URL`.

## üì¶ Complete Example Deployments

### Laravel Application with MariaDB

```yaml
# values-laravel-example.yaml
appConfig:
  framework: "laravel"
  configMap:
    APP_ENV: "production"
    APP_NAME: "My Laravel App"
    LOG_LEVEL: "info"

# Your application image
controllers:
  main:
    containers:
      main:
        image:
          repository: "your-registry/laravel-app"
          tag: "v1.0.0"

# Enable database
mariadb:
  enabled: true
  database:
    mariaDbRef:
      name: "framework-mariadb"  # MariaDB instance name

# Enable ingress (will create my-laravel-app.localhost)
ingress:
  main:
    enabled: true
    className: "traefik"
    dynamicDomain: "localhost"
```

Deploy:
```bash
helm install my-laravel-app . -f values-laravel-example.yaml
```

### WordPress Site with Storage

```yaml
# values-wordpress-example.yaml
appConfig:
  framework: "wordpress"
  configMap:
    WORDPRESS_TABLE_PREFIX: "wp_"

controllers:
  main:
    containers:
      main:
        image:
          repository: "wordpress"
          tag: "6.4-apache"

mariadb:
  enabled: true
  database:
    mariaDbRef:
      name: "framework-mariadb"

# WordPress needs persistent storage
persistence:
  app-data:
    enabled: true
    size: 20Gi
    globalMounts:
      - path: /var/www/html/wp-content

ingress:
  main:
    enabled: true
    className: "traefik"
    dynamicDomain: "localhost"
```

Deploy:
```bash
helm install my-wordpress . -f values-wordpress-example.yaml
```

### Symfony Application

```yaml
# values-symfony-example.yaml
appConfig:
  framework: "symfony"
  configMap:
    APP_ENV: "prod"
    APP_SECRET: "your-symfony-secret"

controllers:
  main:
    containers:
      main:
        image:
          repository: "your-registry/symfony-app"
          tag: "latest"

mariadb:
  enabled: true
  database:
    mariaDbRef:
      name: "framework-mariadb"

persistence:
  app-data:
    enabled: true
    size: 8Gi
    globalMounts:
      - path: /var/www/html/var

ingress:
  main:
    enabled: true
    className: "traefik"
    dynamicDomain: "localhost"
```

Deploy:
```bash
helm install my-symfony . -f values-symfony-example.yaml
```

## üóÑÔ∏è Database Setup

### Prerequisites
You need a MariaDB instance running with the MariaDB operator. Install it:

```bash
# Install MariaDB operator
helm repo add mariadb-operator https://mariadb-operator.github.io/mariadb-operator
helm install mariadb-operator-crds mariadb-operator/mariadb-operator-crds
helm install mariadb-operator mariadb-operator/mariadb-operator

# Create a MariaDB instance
kubectl apply -f - <<EOF
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: framework-mariadb
spec:
  image: mariadb:10.11
  port: 3306
  username: root
  passwordSecretKeyRef:
    name: mariadb-root-password
    key: password
  database: framework
  storage:
    size: 10Gi
EOF
```

### Automatic Database Configuration
When you enable `mariadb.enabled: true`, the chart automatically:

1. **Creates a database** named `{release-name}-db`
2. **Creates a user** named `{release-name}-user` with a random password
3. **Grants permissions** to the user on the database
4. **Detects connection details** from the MariaDB operator (host, port, version)
5. **Generates environment variables** based on your framework setting

## üåê Dynamic Ingress

The chart supports dynamic ingress host generation:

```yaml
ingress:
  main:
    enabled: true
    className: "traefik"                    # Your ingress controller
    dynamicDomain: "localhost"              # Or your domain
    # Will create: {release-name}.localhost
```

For production, create a `staging-domain` secret:
```bash
kubectl create secret generic staging-domain --from-literal=domain=yourdomain.com
```

## üîß Configuration Reference

### Essential Settings

| Setting | Description | Example |
|---------|-------------|---------|
| `appConfig.framework` | Framework detection (laravel/wordpress/symfony) | `"laravel"` |
| `controllers.main.containers.main.image.repository` | Your application image | `"your-registry/app"` |
| `controllers.main.containers.main.image.tag` | Image tag | `"v1.0.0"` |
| `mariadb.enabled` | Enable database integration | `true` |
| `mariadb.database.mariaDbRef.name` | MariaDB instance name | `"framework-mariadb"` |
| `ingress.main.enabled` | Enable ingress | `true` |
| `ingress.main.dynamicDomain` | Domain for ingress | `"localhost"` |

### Application Environment Variables

Add any environment variables your application needs:

```yaml
appConfig:
  configMap:
    # Framework-specific database variables are added automatically
    # Add your custom variables here:
    APP_ENV: "production"
    LOG_LEVEL: "info"
    MAILER_DSN: "smtp://smtp.example.com:587"
    REDIS_URL: "redis://redis:6379"
```

### Storage Configuration

Configure persistent storage for your application:

```yaml
persistence:
  app-data:
    enabled: true
    size: 10Gi
    globalMounts:
      - path: /var/www/html/storage      # Laravel
      # - path: /var/www/html/var        # Symfony
      # - path: /var/www/html/wp-content # WordPress
```

### Scaling and Resources

Configure replicas and resource limits:

```yaml
controllers:
  main:
    replicas: 3
    containers:
      main:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
```

## üß™ Testing Your Deployment

After deployment, test your application:

```bash
# Check pod status
kubectl get pods -l app.kubernetes.io/instance=my-app

# Check database connection
kubectl exec -it deployment/my-app -- env | grep -E "^(DB_|DATABASE_|WORDPRESS_DB_)"

# Test ingress (if enabled)
curl -H "Host: my-app.localhost" http://localhost

# View logs
kubectl logs -l app.kubernetes.io/instance=my-app -f
```

## üöÄ Production Deployment

For production, use values files:

1. **Create your values file** (e.g., `production-laravel.yaml`)
2. **Set production-ready settings**:
   - Specific image tags (not `latest`)
   - Resource limits and requests
   - Multiple replicas for HA
   - Persistent storage configuration
   - Proper ingress with TLS

```bash
# Production deployment
helm upgrade --install my-laravel-app . \
  -f production-laravel.yaml \
  --namespace production \
  --create-namespace
```

## üîç Troubleshooting

### Database Connection Issues
```bash
# Check MariaDB instance
kubectl get mariadb framework-mariadb

# Check generated database resources
kubectl get database,user,grant -l app.kubernetes.io/instance=my-app

# Verify database environment variables
kubectl exec deployment/my-app -- env | grep -E "^(DB_|DATABASE_)"
```

### Ingress Issues
```bash
# Check ingress resource
kubectl get ingress

# Test from inside cluster
kubectl run test --rm -i --tty --image=nginx:alpine -- /bin/sh
# Then: curl http://my-app-application:80
```

## ü§ù Contributing

This chart uses the [bjw-s common library](https://bjw-s.github.io/helm-charts/) for Kubernetes best practices. When contributing:

1. Test with all supported frameworks
2. Maintain framework detection functionality
3. Follow bjw-s patterns for consistency
4. Update documentation for new features

---

**üéØ The goal**: Deploy any application with minimal configuration by specifying framework and image. Everything else is handled automatically!